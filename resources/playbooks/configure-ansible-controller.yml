---

- name: configure controller
  hosts:
    - all
  gather_facts: no
  pre_tasks:
    - name: force evaluation of controller_templates if _local and _imported are set
      ansible.builtin.set_fact:
        controller_templates: "{{ lookup('vars', 'controller_templates_imported') + lookup('vars', 'controller_templates_local') }}"
      when:
        - controller_templates_local is defined
        - controller_templates_imported is defined
        - controller_templates is not defined
    
    - name: bootstrap block
      block:
        - name: run credential config rule
          ansible.builtin.include_role:
            name: redhat_cop_controller_configuration.credentials
          vars:
            controller_credentials: "{{ lookup('var', 'controller_content_credentials') }}"
      when:
        - controller_content_credentials is defined

  tasks:
    - name: ansible controller configuration block
      block:
        - name: include pre-inventory sync configuration roles
          ansible.builtin.include_role:
            name: "{{ role }}"
          loop_control:
            loop_var: role
          loop:
            - redhat_cop.controller_configuration.organizations
            - redhat_cop.controller_configuration.credential_types
            - redhat_cop.controller_configuration.credentials
            - redhat_cop.controller_configuration.execution_environments
            - redhat_cop.controller_configuration.teams
            - redhat_cop.controller_configuration.users
            - redhat_cop.controller_configuration.inventories
        - name: include roles to setup inventory source if defined
          ansible.builtin.include_role:
            name: "{{ role }}"
          loop_control:
            loop_var: role
          loop:        
            - redhat_cop.controller_configuration.inventory_sources
            - redhat_cop.controller_configuration.inventory_source_update
          when:
            controller_inventory_sources is defined
        - name: include roles to create hosts if statically defined
          ansible.builtin.include_role:
            name: "{{ role }}"
          loop_control:
            loop_var: role
          loop:        
            - redhat_cop.controller_configuration.hosts
          when:
            controller_inventory_sources is not defined
        - name: pause for inventory sync
          ansible.builtin.pause:
            seconds: 30
          when:
            controller_inventory_sources is defined
        - name: include post-inventory sync configuration roles
          ansible.builtin.include_role:
            name: "{{ role }}"
          loop_control:
            loop_var: role
          loop:      
            - redhat_cop.controller_configuration.groups
            - redhat_cop.controller_configuration.projects
            - redhat_cop.controller_configuration.job_templates
            - redhat_cop.controller_configuration.workflow_job_templates
            - redhat_cop.controller_configuration.roles
      when:
        - configure_controller | bool